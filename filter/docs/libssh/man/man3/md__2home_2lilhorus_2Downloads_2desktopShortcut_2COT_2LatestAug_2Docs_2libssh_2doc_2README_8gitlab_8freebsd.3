.TH "md__2home_2mock_2libssh_2doc_2README_8gitlab_8freebsd" 3 "My Project" \" -*- nroff -*-
.ad l
.nh
.SH NAME
md__2home_2mock_2libssh_2doc_2README_8gitlab_8freebsd \- Install a FreeBSD CI instance
.PP


.PP
Install the following packages:

.PP
.PP
.nf
pkg install \-y bash git gmake cmake cmocka openssl wget pkgconf ccache bash
.fi
.PP

.PP
Create gitlab-runner user:

.PP
.PP
.nf
pw group add \-n gitlab\-runner
pw user add \-n gitlab\-runner \-g gitlab\-runner \-s /usr/local/bin/bash
mkdir /home/gitlab\-runner
chown gitlab\-runner:gitlab\-runner /home/gitlab\-runner
.fi
.PP

.PP
Get the gitlab-runner binary for freebsd:

.PP
.PP
.nf
wget \-O /usr/local/bin/gitlab\-runner https://gitlab\-runner\-downloads\&.s3\&.amazonaws\&.com/latest/binaries/gitlab\-runner\-freebsd\-amd64
chmod +x /usr/local/bin/gitlab\-runner
.fi
.PP

.PP
Create a log file and allow access:

.PP
.PP
.nf
touch /var/log/gitlab_runner\&.log && chown gitlab\-runner:gitlab\-runner /var/log/gitlab_runner\&.log
.fi
.PP

.PP
We need a start script to run it on boot:

.PP
.PP
.nf
mkdir \-p /usr/local/etc/rc\&.d
cat > /usr/local/etc/rc\&.d/gitlab_runner << EOF
#!/usr/local/bin/bash
# PROVIDE: gitlab_runner
# REQUIRE: DAEMON NETWORKING
# BEFORE:
# KEYWORD:

\&. /etc/rc\&.subr

name="gitlab_runner"
rcvar="gitlab_runner_enable"

load_rc_config $name

user="gitlab\-runner"
user_home="/home/gitlab\-runner"
command="/usr/local/bin/gitlab\-runner run"
pidfile="/var/run/${name}\&.pid"

start_cmd="gitlab_runner_start"
stop_cmd="gitlab_runner_stop"
status_cmd="gitlab_runner_status"

gitlab_runner_start()
{
    export USER=${user}
    export HOME=${user_home}

    if checkyesno ${rcvar}; then
        cd ${user_home}
        /usr/sbin/daemon \-u ${user} \-p ${pidfile} ${command} > /var/log/gitlab_runner\&.log 2>&1
    fi
}

gitlab_runner_stop()
{
    if [ \-f ${pidfile} ]; then
        kill `cat ${pidfile}`
    fi
}

gitlab_runner_status()
{
    if [ ! \-f ${pidfile} ] || kill \-0 `cat ${pidfile}`; then
        echo "Service ${name} is not running\&."
    else
        echo "${name} appears to be running\&."
    fi
}

run_rc_command $1
EOF
chmod +x /usr/local/etc/rc\&.d/gitlab_runner
.fi
.PP

.PP
Register your gitlab-runner with your gitlab project

.PP
.PP
.nf
su gitlab\-runner \-c 'gitlab\-runner register'
.fi
.PP

.PP
Start the gitlab runner service:

.PP
.PP
.nf
sysrc \-f /etc/rc\&.conf "gitlab_runner_enable=YES"
service gitlab_runner start
.fi
.PP
